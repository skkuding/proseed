generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 성장기록, 피드백 카테고리 통일
enum RecordCategory {
  PLAN
  DESIGN
  DEVELOPMENT
  GENERAL
}

//TODO: MVP에서는 프로젝트 생성자 제외하고 모두 같은 MEMBER, 추후 팀장 권한 확대
enum ProjectRoleType {
  ADMIN
  MEMBER
}

enum Provider {
  KAKAO
  NAVER
  GOOGLE
}

enum ProjectCategory {
  HEALTHCARE
  FINANCE
  PUBLIC
  COMMERCE
  EDUCATION
  ENTERTAINMENT
  MOBILITY
  ENERGY
  REALESTATE
  LIFESTYLE
  PRODUCTIVITY
  COMMUNITY
  AI
}

enum JobType {
  Planner
  Designer
  Developer
  Other
}

model User {
  id               Int      @id @default(autoincrement())
  name             String
  email            String?  @unique
  createdAt        DateTime @default(now()) @map("created_at")
  ownedTicketCount Int      @default(0) @map("owned_ticket_count")
  jobType          JobType?
  bio              String?
  birth            String?
  profileImageUrl  String?

  projectRoles ProjectRole[]
  feedbacks    Feedback[]
  userOAuths   UserOAuth[]
  projects     Project[]

  @@map("user")
}

model UserOAuth {
  id         String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     Int      @map("user_id")
  provider   Provider
  createTime DateTime @default(now()) @map("create_time")
  updateTime DateTime @updatedAt @map("update_time")

  @@id([id, provider])
  @@map("user_oauth")
}

enum ProjectType {
  APP
  WEB
}

enum ProjectStatus {
  Available
  MVP
  Ongoing
  Hiring
}

model Project {
  id                 Int               @id @default(autoincrement())
  title              String
  createdBy          User              @relation(fields: [createdById], references: [id])
  createdById        Int
  type               ProjectType
  status             ProjectStatus
  oneLineDescription String            @map("one_line_description")
  description        String
  category           ProjectCategory[]
  contactPath        String            @map("contact_path")
  projectLink        String            @map("project_link")
  iconUrl            String            @map("icon_url")
  thumbnailUrl       String            @map("thumbnail_url")
  createdAt          DateTime          @default(now()) @map("created_at")
  updatedAt          DateTime          @updatedAt @map("updated_at")

  versions          ProjectVersion[]
  projectRoles      ProjectRole[]
  feedbackQuestions FeedbackQuestion[]
  images            ProjectImage[]
  feedbacks         Feedback[]

  @@map("project")
}

model ProjectImage {
  id        Int      @id @default(autoincrement())
  projectId Int      @map("project_id")
  url       String // S3 URL 또는 key
  order     Int      @default(0) // 정렬 순서
  createdAt DateTime @default(now()) @map("created_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("project_image")
}

model ProjectVersion {
  id            Int       @id @default(autoincrement())
  projectId     Int       @map("project_id")
  version       String
  updateGoal    String    @map("update_goal")
  updateResults String[]  @map("update_results")
  releasedAt    DateTime? @map("released_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  project       Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  growthRecords GrowthRecord[]

  @@unique([projectId, version])
  @@map("project_version")
}

model GrowthRecord {
  id        Int            @id @default(autoincrement())
  versionId Int            @map("version_id")
  category  RecordCategory
  createdAt DateTime       @default(now()) @map("created_at")
  updatedAt DateTime       @updatedAt @map("updated_at")

  version  ProjectVersion        @relation(fields: [versionId], references: [id], onDelete: Cascade)
  contents GrowthRecordContent[]
  images   GrowthRecordImage[]

  @@unique([versionId, category])
  @@map("growth_record")
}

model GrowthRecordImage {
  id             Int      @id @default(autoincrement())
  growthRecordId Int      @map("growth_record_id")
  url            String
  order          Int      @default(0)
  createdAt      DateTime @default(now()) @map("created_at")

  growthRecord GrowthRecord @relation(fields: [growthRecordId], references: [id], onDelete: Cascade)

  @@map("growth_record_image")
}

model ProjectRole {
  id        Int             @id @default(autoincrement())
  userId    Int             @map("user_id")
  projectId Int             @map("project_id")
  role      ProjectRoleType @default(MEMBER)

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
  @@map("project_role")
}

model FeedbackQuestion {
  id          Int            @id @default(autoincrement())
  projectId   Int            @map("project_id")
  category    RecordCategory
  title       String
  description String
  order       Int            @default(0)
  isRequired  Boolean        @default(false) @map("is_required")

  project   Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  feedbacks Feedback[]

  @@map("feedback_question")
}

model GrowthRecordContent {
  id             Int     @id @default(autoincrement())
  growthRecordId Int     @map("growth_record_id")
  title          String
  content        String
  isDefault      Boolean @default(false) @map("is_default")

  growthRecord GrowthRecord @relation(fields: [growthRecordId], references: [id], onDelete: Cascade)

  @@map("growth_record_content")
}

model Feedback {
  id         Int      @id @default(autoincrement())
  questionId Int      @map("question_id")
  projectId  Int      @map("project_id")
  userId     Int      @map("user_id")
  content    String
  createdAt  DateTime @default(now()) @map("created_at")

  question  FeedbackQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  createdBy User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  project   Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("feedback")
}
